{
  "feature": "Upgrade LangChain Dependencies to 0.3.x for Deep Agents",
  "workflow_type": "feature",
  "workflow_rationale": "This is a dependency upgrade that enables new capabilities (Deep Agents support) while preserving existing RAG workflow functionality. Classified as feature enhancement rather than bugfix or refactor.",
  "phases": [
    {
      "id": "phase-1-upgrade",
      "name": "Dependency Upgrade",
      "type": "setup",
      "description": "Upgrade all 7 LangChain packages to version 0.3.x+ in requirements.txt",
      "depends_on": [],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Update LangChain package versions in requirements.txt",
          "service": "backend",
          "files_to_modify": [
            "backend/requirements.txt"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/requirements.txt"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && pip list | grep -E 'langchain|langgraph'",
            "expected": "All packages show version 0.3.x or higher"
          },
          "status": "completed",
          "notes": "Added langchain-text-splitters>=0.3.0 to requirements.txt to complete the 7 LangChain packages required for Deep Agents support. All packages now specified at >=0.3.0: langchain, langchain-core, langchain-community, langchain-anthropic, langchain-openai, langchain-text-splitters, langgraph. Committed as efba3b9.",
          "updated_at": "2025-12-31T01:51:35.005791+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Install upgraded dependencies and verify installation",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pip check",
            "expected": "No broken dependencies"
          },
          "status": "completed",
          "notes": "Successfully installed all upgraded LangChain dependencies in backend/venv. Verified with `pip check` (no broken dependencies). All packages at version \u22650.3.0: langchain 1.2.0, langchain-core 1.2.5, langchain-community 0.4.1, langchain-anthropic 1.3.0, langchain-openai 1.1.6, langchain-text-splitters 1.1.0, langgraph 1.0.5, langgraph-checkpoint 3.0.1, langgraph-prebuilt 1.0.5, langgraph-sdk 0.3.1",
          "updated_at": "2025-12-31T01:54:11.360903+00:00"
        }
      ]
    },
    {
      "id": "phase-2-verify-imports",
      "name": "Import Verification",
      "type": "implementation",
      "description": "Verify all LangChain imports succeed and check for API compatibility",
      "depends_on": [
        "phase-1-upgrade"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Verify LangChain-Core imports and patterns",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "backend/app/core/state.py",
            "backend/agent_graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from langchain_core.messages import HumanMessage, AIMessage, SystemMessage, BaseMessage; from langchain_core.tools import tool; from langchain_core.prompts import ChatPromptTemplate; print('LangChain-Core imports OK')\"",
            "expected": "LangChain-Core imports OK"
          },
          "status": "pending",
          "notes": "Verifies message classes, @tool decorator, and prompt templates still work in 0.3.x"
        },
        {
          "id": "subtask-2-2",
          "description": "Verify LangChain-Anthropic compatibility",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "backend/app/core/llm.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from langchain_anthropic import ChatAnthropic; llm = ChatAnthropic(model='claude-3-haiku-20240307', temperature=0); print('ChatAnthropic init OK')\"",
            "expected": "ChatAnthropic init OK"
          },
          "status": "pending",
          "notes": "Verifies ChatAnthropic initialization pattern. Requires ANTHROPIC_API_KEY environment variable."
        },
        {
          "id": "subtask-2-3",
          "description": "Verify LangGraph StateGraph and checkpointing",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "backend/app/core/graph.py",
            "backend/agent_graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from langgraph.graph import StateGraph, START, END; from langgraph.checkpoint.sqlite import SqliteSaver; from langgraph.prebuilt import ToolNode, tools_condition; print('LangGraph imports OK')\"",
            "expected": "LangGraph imports OK"
          },
          "status": "pending",
          "notes": "Critical verification - LangGraph 0.2\u21920.3 may have breaking changes in StateGraph API, conditional edges, or interrupts"
        },
        {
          "id": "subtask-2-4",
          "description": "Verify RAG pipeline imports (PyPDFLoader, text splitters, embeddings)",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [
            "backend/data_processing/loaders/guidelines_loader.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from langchain_community.document_loaders import PyPDFLoader; from langchain_text_splitters import RecursiveCharacterTextSplitter; from langchain_openai import OpenAIEmbeddings; print('RAG pipeline imports OK')\"",
            "expected": "RAG pipeline imports OK"
          },
          "status": "pending",
          "notes": "High risk: PyPDFLoader version jump from 0.0.10\u21920.3.0 is significant. Must verify API compatibility immediately."
        }
      ]
    },
    {
      "id": "phase-3-graph-verification",
      "name": "Graph Compilation Verification",
      "type": "implementation",
      "description": "Verify all LangGraph workflows compile successfully with new version",
      "depends_on": [
        "phase-2-verify-imports"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Verify agent_graph.py compiles",
          "service": "backend",
          "files_to_modify": [
            "backend/agent_graph.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/agent_graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from agent_graph import app; print('Agent graph compiled:', app is not None)\"",
            "expected": "Agent graph compiled: True"
          },
          "status": "pending",
          "notes": "Uses @tool decorator, bind_tools(), and SqliteSaver checkpointing. If fails, check for breaking changes in ToolNode or tools_condition."
        },
        {
          "id": "subtask-3-2",
          "description": "Verify epicrisis_graph.py compiles",
          "service": "backend",
          "files_to_modify": [
            "backend/epicrisis_graph.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/epicrisis_graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from epicrisis_graph import app; print('Epicrisis graph compiled:', app is not None)\"",
            "expected": "Epicrisis graph compiled: True"
          },
          "status": "pending",
          "notes": "Verify graph compilation and message handling patterns"
        },
        {
          "id": "subtask-3-3",
          "description": "Verify translator_graph.py compiles",
          "service": "backend",
          "files_to_modify": [
            "backend/translator_graph.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/translator_graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from translator_graph import app; print('Translator graph compiled:', app is not None)\"",
            "expected": "Translator graph compiled: True"
          },
          "status": "pending",
          "notes": "Verify async invocation patterns work in 0.3.x"
        },
        {
          "id": "subtask-3-4",
          "description": "Verify app/core/graph.py (main workflow) compiles",
          "service": "backend",
          "files_to_modify": [
            "backend/app/core/graph.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "backend/app/core/graph.py"
          ],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from app.core.graph import app; print('Clinical workflow graph compiled:', app is not None)\"",
            "expected": "Clinical workflow graph compiled: True"
          },
          "status": "pending",
          "notes": "Main RAG workflow graph with conditional edges, iteration control, and checkpointing. Critical path for functionality."
        }
      ]
    },
    {
      "id": "phase-4-unit-tests",
      "name": "Unit Tests Execution",
      "type": "implementation",
      "description": "Run existing unit test suite and verify zero failures",
      "depends_on": [
        "phase-3-graph-verification"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Run graph-related tests",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest tests/test_graph.py tests/test_state.py -v",
            "expected": "All tests pass (0 failures)"
          },
          "status": "pending",
          "notes": "Tests StateGraph functionality, message handling, and state management. If failures occur, check for API changes in message classes or state handling."
        },
        {
          "id": "subtask-4-2",
          "description": "Run tool-related tests",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest tests/test_tools_registry.py tests/test_tools_mcp_integration.py tests/test_tools_base.py -v",
            "expected": "All tests pass (0 failures)"
          },
          "status": "pending",
          "notes": "Tests @tool decorator and tool binding. If failures occur, check for changes in tool definition or binding APIs."
        },
        {
          "id": "subtask-4-3",
          "description": "Run RAG pipeline tests (PyPDFLoader critical path)",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest tests/test_multiformat_pdf_support.py tests/test_guidelines_loader.py -v",
            "expected": "All tests pass (0 failures)"
          },
          "status": "pending",
          "notes": "CRITICAL: PyPDFLoader version jump 0.0.10\u21920.3.0. If failures occur, check PyPDFLoader API changes for load() method or document structure."
        },
        {
          "id": "subtask-4-4",
          "description": "Run search service tests",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest tests/test_search_service.py -v",
            "expected": "All tests pass (0 failures)"
          },
          "status": "pending",
          "notes": "Tests integration with retrievers and embeddings"
        }
      ]
    },
    {
      "id": "phase-5-integration-tests",
      "name": "Integration Tests & E2E Verification",
      "type": "integration",
      "description": "Run integration tests and verify RAG workflow end-to-end",
      "depends_on": [
        "phase-4-unit-tests"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Run integration tests",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest tests/test_api_integration.py tests/test_guideline_pipeline_e2e.py tests/test_rag_flow_verification.py -v",
            "expected": "All integration tests pass (0 failures)"
          },
          "status": "pending",
          "notes": "Tests full RAG workflow: PDF loading \u2192 chunking \u2192 embeddings \u2192 retrieval \u2192 LLM response"
        },
        {
          "id": "subtask-5-2",
          "description": "Verify full test suite with deprecation warnings enabled",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && pytest -W default 2>&1 | grep -i deprecat || echo 'No deprecation warnings found'",
            "expected": "No deprecation warnings found"
          },
          "status": "pending",
          "notes": "Critical requirement: Zero deprecation warnings. If warnings found, must address deprecated API usage."
        },
        {
          "id": "subtask-5-3",
          "description": "Verify Deep Agents features are accessible",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from langgraph.prebuilt import ToolNode; import langgraph; print('LangGraph version:', langgraph.__version__); print('Deep Agents features accessible')\"",
            "expected": "LangGraph version: 0.3.x and Deep Agents features accessible"
          },
          "status": "pending",
          "notes": "Confirms Deep Agents functionality is enabled in LangGraph 0.3.x"
        },
        {
          "id": "subtask-5-4",
          "description": "End-to-end verification: Start backend and test RAG query endpoint",
          "all_services": false,
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "1. Start backend: cd backend && uvicorn main:app --reload --port 8000\n2. Test health: curl http://localhost:8000/health\n3. Test RAG query: curl -X POST http://localhost:8000/api/v1/query/ -H 'Content-Type: application/json' -d '{\"query\": \"test query\"}'\n4. Verify response contains answer and context\n5. Check logs for any errors or warnings"
          },
          "status": "pending",
          "notes": "Final validation that RAG workflow functions identically post-upgrade. Requires ANTHROPIC_API_KEY and OPENAI_API_KEY environment variables."
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 16,
    "services_involved": [
      "backend"
    ],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution required due to dependencies"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 001"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All 7 LangChain packages at version \u22650.3.0",
      "All existing tests pass (0 failures)",
      "No deprecation warnings in test output",
      "Backend starts successfully",
      "RAG workflow endpoints return valid responses",
      "Deep Agents features confirmed accessible"
    ],
    "verification_steps": [
      {
        "name": "Package Version Check",
        "command": "cd backend && pip list | grep -E 'langchain|langgraph'",
        "expected_outcome": "All packages show 0.3.x or higher",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Unit Tests",
        "command": "cd backend && pytest tests/ -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Deprecation Warning Check",
        "command": "cd backend && pytest -W default 2>&1 | grep -i deprecat",
        "expected_outcome": "No deprecation warnings",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "cd backend && pytest tests/test_api_integration.py tests/test_guideline_pipeline_e2e.py tests/test_rag_flow_verification.py -v",
        "expected_outcome": "All integration tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High risk due to major version upgrade (0.1.x\u21920.3.x) with strict zero-failure requirement. Unit and integration tests verify backward compatibility. No E2E tests needed (backend-only change)."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest backend/tests/ -v"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "pytest backend/tests/test_api_integration.py backend/tests/test_guideline_pipeline_e2e.py backend/tests/test_rag_flow_verification.py -v"
      ],
      "services_to_test": [
        "backend"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "api_verification": {
      "required": true,
      "endpoints": [
        {
          "name": "Health Check",
          "url": "http://localhost:8000/health",
          "method": "GET",
          "expected_status": 200
        },
        {
          "name": "RAG Query",
          "url": "http://localhost:8000/api/v1/query/",
          "method": "POST",
          "body": {
            "query": "test query"
          },
          "expected_status": 200
        }
      ]
    },
    "dependency_verification": {
      "required": true,
      "checks": [
        {
          "name": "LangChain Version",
          "command": "pip show langchain | grep Version",
          "expected": "Version: 0.3.x"
        },
        {
          "name": "LangGraph Version",
          "command": "pip show langgraph | grep Version",
          "expected": "Version: 0.3.x"
        },
        {
          "name": "No Dependency Conflicts",
          "command": "pip check",
          "expected": "No broken dependencies"
        }
      ]
    }
  },
  "qa_signoff": null,
  "last_updated": "2025-12-31T01:54:11.360920+00:00"
}