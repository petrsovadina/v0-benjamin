{
  "feature": "Comprehensive Testing Infrastructure",
  "workflow_type": "feature",
  "workflow_rationale": "This is a substantial new capability (frontend testing infrastructure from scratch) combined with enhancement of existing infrastructure (backend tests). It requires multi-file changes across both services, configuration setup, and new code creation.",
  "phases": [
    {
      "id": "phase-1-backend-config",
      "name": "Backend Test Configuration",
      "type": "setup",
      "description": "Set up backend pytest configuration and shared fixtures",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create pyproject.toml with pytest and coverage configuration",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["backend/pyproject.toml"],
          "patterns_from": ["backend/tests/test_api_integration.py"],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"import tomllib; f=open('pyproject.toml','rb'); print('OK' if 'pytest' in str(tomllib.load(f)) else 'FAIL')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-2",
          "description": "Create conftest.py with shared fixtures (mock_supabase, mock_graph_app, TestClient)",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": ["backend/tests/conftest.py"],
          "patterns_from": ["backend/tests/test_api_integration.py"],
          "verification": {
            "type": "command",
            "command": "cd backend && python -c \"from tests.conftest import mock_supabase, mock_graph_app; print('OK')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-1-3",
          "description": "Verify existing backend tests still pass with new configuration",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && python -m pytest tests/test_api_integration.py -v --tb=short",
            "expected": "passed"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-2-frontend-setup",
      "name": "Frontend Test Infrastructure Setup",
      "type": "setup",
      "description": "Install dependencies and create Vitest configuration for React testing",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Add test dependencies to package.json (vitest, testing-library, jsdom)",
          "service": "main",
          "files_to_modify": ["package.json"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -q 'vitest' package.json && grep -q '@testing-library/react' package.json && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-2",
          "description": "Create vitest.config.ts with jsdom environment and React plugin",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["vitest.config.ts"],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "test -f vitest.config.ts && grep -q 'jsdom' vitest.config.ts && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-3",
          "description": "Create vitest.setup.ts with @testing-library/jest-dom import",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["vitest.setup.ts"],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "test -f vitest.setup.ts && grep -q 'jest-dom' vitest.setup.ts && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-2-4",
          "description": "Install frontend test dependencies with pnpm",
          "service": "main",
          "files_to_modify": ["pnpm-lock.yaml"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pnpm list vitest @testing-library/react --depth=0 2>/dev/null | grep -q 'vitest' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-3-component-tests",
      "name": "Frontend Component Tests",
      "type": "implementation",
      "description": "Create unit tests for core UI components using React Testing Library",
      "depends_on": ["phase-2-frontend-setup"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create Button component tests (render, click handlers, variants)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["components/__tests__/button.test.tsx"],
          "patterns_from": ["components/ui/button.tsx"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run components/__tests__/button.test.tsx --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-2",
          "description": "Create Input component tests (render, placeholder, type handling)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["components/__tests__/input.test.tsx"],
          "patterns_from": ["components/ui/input.tsx"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run components/__tests__/input.test.tsx --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-3",
          "description": "Create Card component tests (render, structure, className merging)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["components/__tests__/card.test.tsx"],
          "patterns_from": ["components/ui/card.tsx"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run components/__tests__/card.test.tsx --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-4",
          "description": "Create ChatInterface component tests (message rendering, input handling)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["components/__tests__/chat-interface.test.tsx"],
          "patterns_from": ["components/dashboard/chat-interface.tsx"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run components/__tests__/chat-interface.test.tsx --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-3-5",
          "description": "Create Sidebar component tests (navigation links, active state)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["components/__tests__/sidebar.test.tsx"],
          "patterns_from": ["components/dashboard/sidebar.tsx"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run components/__tests__/sidebar.test.tsx --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-4-lib-tests",
      "name": "Frontend Library Tests",
      "type": "implementation",
      "description": "Create unit tests for lib utility functions and server actions",
      "depends_on": ["phase-2-frontend-setup"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Create utils.ts tests (cn function, class merging edge cases)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["lib/__tests__/utils.test.ts"],
          "patterns_from": ["lib/utils.ts"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run lib/__tests__/utils.test.ts --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-2",
          "description": "Create auth-actions.ts tests (signUp, signIn, signOut with mocked Supabase)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": ["lib/__tests__/auth-actions.test.ts"],
          "patterns_from": ["lib/auth-actions.ts"],
          "verification": {
            "type": "command",
            "command": "pnpm vitest run lib/__tests__/auth-actions.test.ts --reporter=verbose 2>&1 | grep -q 'pass' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-integration",
      "name": "Integration and Verification",
      "type": "integration",
      "description": "Add npm scripts, update .gitignore, verify end-to-end test execution",
      "depends_on": ["phase-1-backend-config", "phase-3-component-tests", "phase-4-lib-tests"],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Add test and test:coverage scripts to package.json",
          "service": "main",
          "files_to_modify": ["package.json"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -q '\"test\"' package.json && grep -q '\"test:coverage\"' package.json && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Update .gitignore with coverage artifacts (.coverage, htmlcov/, coverage/)",
          "service": "main",
          "files_to_modify": [".gitignore"],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "grep -q 'htmlcov' .gitignore && grep -q '.coverage' .gitignore && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "Run all frontend tests and verify passing",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pnpm test 2>&1 | tail -5",
            "expected": "pass"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-4",
          "description": "Run all backend tests and verify passing",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "cd backend && python -m pytest tests/ -v --tb=short 2>&1 | tail -5",
            "expected": "passed"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-5",
          "description": "Verify coverage commands work (frontend and backend)",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pnpm test:coverage 2>&1 | grep -q 'Coverage' && echo 'OK'",
            "expected": "OK"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 17,
    "services_involved": ["main", "backend"],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": ["phase-1-backend-config", "phase-2-frontend-setup"],
          "reason": "Both are setup phases with no dependencies, work on different services"
        },
        {
          "phases": ["phase-3-component-tests", "phase-4-lib-tests"],
          "reason": "Both depend only on phase-2, create different test files"
        }
      ],
      "recommended_workers": 2,
      "speedup_estimate": "1.4x faster than sequential"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 006 --parallel 2"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "during_implementation",
    "test_types_required": ["unit", "integration"],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing backend tests pass",
      "All new frontend tests pass",
      "Coverage commands produce reports",
      "No console errors in test output",
      "At least 5 component test files created",
      "At least 2 lib test files created"
    ],
    "verification_steps": [
      {
        "name": "Frontend Tests",
        "command": "pnpm test",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Backend Tests",
        "command": "cd backend && python -m pytest tests/ -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Frontend Coverage",
        "command": "pnpm test:coverage",
        "expected_outcome": "Coverage report generated",
        "type": "test",
        "required": true,
        "blocking": false
      },
      {
        "name": "Backend Coverage",
        "command": "cd backend && python -m pytest --cov=. tests/",
        "expected_outcome": "Coverage report generated",
        "type": "test",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk testing infrastructure task - focus on ensuring tests run correctly. Security not a concern since we're adding tests, not modifying business logic."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": ["pnpm test", "cd backend && python -m pytest tests/"],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": ["cd backend && python -m pytest tests/test_api_integration.py -v"],
      "services_to_test": ["backend"]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "configuration_verification": {
      "required": true,
      "checks": [
        {"file": "vitest.config.ts", "exists": true, "contains": ["jsdom", "setupFiles"]},
        {"file": "vitest.setup.ts", "exists": true, "contains": ["@testing-library/jest-dom"]},
        {"file": "backend/pyproject.toml", "exists": true, "contains": ["pytest", "coverage"]},
        {"file": "backend/tests/conftest.py", "exists": true, "contains": ["mock_supabase", "fixture"]},
        {"file": "package.json", "contains": ["test", "vitest", "@testing-library/react"]}
      ]
    }
  },
  "qa_signoff": null
}
