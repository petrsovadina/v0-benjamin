{
  "integrations_researched": [
    {
      "name": "Playwright",
      "type": "library",
      "purpose": "E2E testing framework for Next.js application",
      "verified_package": {
        "name": "@playwright/test",
        "install_command": "npm install -D @playwright/test && npx playwright install",
        "version": "latest (^1.51.0)",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "import { test, expect } from '@playwright/test';",
          "import { defineConfig, devices } from '@playwright/test';"
        ],
        "initialization": "npx playwright install - installs required browsers (Chromium, Firefox, WebKit)",
        "key_functions": [
          "test('description', async ({ page }) => { ... })",
          "test.describe('group', () => { ... })",
          "test.beforeEach(async ({ page }) => { ... })",
          "await page.goto('url')",
          "await page.getByLabel('label').fill('value')",
          "await page.getByRole('button', { name: 'text' }).click()",
          "await expect(page).toHaveURL('url')",
          "await expect(locator).toBeVisible()",
          "await page.context().storageState({ path: authFile })"
        ],
        "verified_against": "Context7 MCP: /microsoft/playwright.dev"
      },
      "configuration": {
        "env_vars": [
          "PLAYWRIGHT_TEST=1 (automatically set)",
          "CI (for CI-specific behavior)"
        ],
        "config_files": [
          "playwright.config.ts"
        ],
        "dependencies": []
      },
      "playwright_config_template": {
        "key_settings": {
          "testDir": "./e2e",
          "fullyParallel": true,
          "forbidOnly": "!!process.env.CI",
          "retries": "process.env.CI ? 2 : 0",
          "workers": "process.env.CI ? 1 : undefined",
          "reporter": "html",
          "use.baseURL": "http://localhost:3000",
          "use.trace": "on-first-retry",
          "webServer.command": "npm run dev",
          "webServer.url": "http://localhost:3000",
          "webServer.reuseExistingServer": "!process.env.CI"
        }
      },
      "authentication_patterns": {
        "strategy": "storageState - save authenticated session to JSON file",
        "setup_project": "Create auth.setup.ts to perform login and save storageState",
        "reuse": "Configure 'setup' project in playwright.config.ts with dependencies",
        "auth_file_location": "playwright/.auth/user.json",
        "gitignore": "Add playwright/.auth to .gitignore"
      },
      "gotchas": [
        "Create playwright/.auth directory and add to .gitignore",
        "Use setup project for authentication - runs once before all tests",
        "For Next.js: webServer.command should match dev server command",
        "Wait for page.waitForURL() after login redirects",
        "Use baseURL in config to simplify page.goto() calls"
      ],
      "research_sources": [
        "Context7 MCP: /microsoft/playwright.dev (13277 snippets, High reputation)",
        "Context7 topics: getting started, nextjs testing, authentication, configuration"
      ]
    },
    {
      "name": "Supabase Auth (SSR)",
      "type": "library",
      "purpose": "Authentication and database for Next.js application",
      "verified_package": {
        "name": "@supabase/ssr + @supabase/supabase-js",
        "install_command": "Already installed in project",
        "version": "latest",
        "verified": true
      },
      "api_patterns": {
        "imports": [
          "import { createBrowserClient } from '@supabase/ssr';",
          "import { createClient } from '@/lib/supabase/server';",
          "import { createClient } from '@/lib/supabase/client';"
        ],
        "initialization": "createBrowserClient<Database>(SUPABASE_URL, SUPABASE_KEY)",
        "key_functions": [
          "await supabase.auth.signInWithPassword({ email, password })",
          "await supabase.auth.signUp({ email, password, options: { data: {...} } })",
          "await supabase.auth.signOut()",
          "await supabase.auth.getSession()",
          "auth.onAuthStateChange((event, session) => { ... })"
        ],
        "verified_against": "Context7 MCP: /supabase/supabase-js + Project source code"
      },
      "configuration": {
        "env_vars": [
          "NEXT_PUBLIC_SUPABASE_URL",
          "NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY"
        ],
        "config_files": [
          "lib/supabase/client.ts (browser client)",
          "lib/supabase/server.ts (server client)",
          "lib/supabase/middleware.ts (middleware)"
        ],
        "dependencies": []
      },
      "project_auth_flow": {
        "login_page": "/auth/login",
        "redirect_after_login": "/dashboard",
        "redirect_after_logout": "/auth/login",
        "server_action": "lib/auth-actions.ts (signIn, signUp, signOut)"
      },
      "e2e_testing_patterns": {
        "login_test": "Navigate to /auth/login, fill email/password, click submit, wait for /dashboard",
        "session_verification": "Check for authenticated UI elements after login",
        "logout_test": "Trigger signOut action, verify redirect to /auth/login"
      },
      "gotchas": [
        "Use storageState in Playwright to persist auth between tests",
        "Server actions use redirect() which throws - handle in tests",
        "Need test user credentials for E2E tests",
        "Browser client vs Server client - different usage patterns"
      ],
      "research_sources": [
        "Context7 MCP: /supabase/supabase-js (90.3 benchmark)",
        "Context7 MCP: /supabase/supabase (testing patterns)",
        "Project source: components/auth/login-form.tsx",
        "Project source: lib/auth-actions.ts"
      ]
    },
    {
      "name": "SUKL Integration",
      "type": "service",
      "purpose": "Czech pharmaceutical database API for drug information",
      "verified_package": {
        "name": "Custom Python backend implementation",
        "install_command": "N/A - Already implemented",
        "version": "N/A",
        "verified": true
      },
      "api_patterns": {
        "base_urls": {
          "test": "https://testapi.sukl.cz",
          "production": "https://api.sukl.cz"
        },
        "authentication": "Client certificate (PEM format)",
        "key_endpoints": [
          "/docs (connection check)",
          "Various drug data endpoints"
        ],
        "verified_against": "Project source: backend/services/sukl_api_client.py"
      },
      "configuration": {
        "env_vars": [
          "SUKL_CERT_PATH - Path to client certificate",
          "SUKL_CERT_PASS - Certificate password"
        ],
        "config_files": [],
        "dependencies": [
          "requests (Python)",
          "Valid SUKL client certificate"
        ]
      },
      "project_implementation": {
        "client": "backend/services/sukl_api_client.py",
        "retrievers": "backend/pipeline/retrievers/sukl_retriever.py",
        "parsers": [
          "backend/data_processing/parsers/sukl_dlp_parser.py",
          "backend/data_processing/parsers/sukl_document_parser.py",
          "backend/data_processing/parsers/sukl_pricing_parser.py"
        ]
      },
      "e2e_testing_approach": {
        "strategy": "Mock SUKL API responses in E2E tests",
        "reason": "External API requires certificate auth, not suitable for E2E tests",
        "mock_location": "Frontend tests should mock the backend API endpoint"
      },
      "gotchas": [
        "Requires client certificate for authentication",
        "Test environment (testapi.sukl.cz) has SSL verification disabled",
        "API responses are in Czech language",
        "E2E tests should mock backend API, not SUKL directly"
      ],
      "research_sources": [
        "Project source: backend/services/sukl_api_client.py",
        "Project source: backend/probe_sukl_api.py"
      ]
    },
    {
      "name": "VZP Navigator",
      "type": "service",
      "purpose": "Czech health insurance (VZP) drug coverage lookup",
      "verified_package": {
        "name": "Custom implementation using Supabase",
        "install_command": "N/A - Already implemented",
        "version": "N/A",
        "verified": true
      },
      "api_patterns": {
        "frontend_endpoint": "${NEXT_PUBLIC_API_URL}/api/v1/drugs/vzp-search",
        "method": "POST",
        "request_body": "{ query: string }",
        "response_format": {
          "results": [
            {
              "id": "string (SUKL code)",
              "name": "string",
              "inn": "string (active substance)",
              "atc": "string (ATC code)",
              "form": "string",
              "coverage": "full | partial | limited",
              "pricing": {
                "max_price": "number",
                "reimbursement": "number",
                "copayment": "number"
              },
              "conditions": "string[]",
              "alternatives": "string[]"
            }
          ]
        },
        "verified_against": "Project source: backend/pipeline/retrievers/vzp_retriever.py + components/dashboard/vzp-search-interface.tsx"
      },
      "configuration": {
        "env_vars": [
          "NEXT_PUBLIC_API_URL - Backend API URL (default: http://localhost:8000)"
        ],
        "config_files": [],
        "dependencies": [
          "Supabase database with drugs and drug_pricing tables"
        ]
      },
      "database_schema": {
        "tables": [
          "drugs - Drug information (sukl_code, name, name_normalized, active_substance, atc_code, strength, pharmaceutical_form)",
          "drug_pricing - Pricing info (sukl_code, max_price_manufacturer, reimbursement_amount, max_copayment)"
        ]
      },
      "frontend_ui": {
        "component": "components/dashboard/vzp-search-interface.tsx",
        "result_card": "components/dashboard/vzp-result-card.tsx",
        "search_input": "Input with placeholder 'Vyhledejte lék...'",
        "submit_button": "Button with text 'Vyhledat'"
      },
      "e2e_testing_approach": {
        "strategy": "Test full flow: search input -> API call -> results display",
        "test_cases": [
          "Search for drug by name (e.g., 'Bisoprolol')",
          "Search for drug by ATC code (e.g., 'C07AB')",
          "Empty search results handling",
          "Loading state display"
        ]
      },
      "gotchas": [
        "All UI text is in Czech language",
        "Coverage status calculated from pricing data",
        "Backend must be running for E2E tests (Python FastAPI)",
        "Need test data in Supabase database"
      ],
      "research_sources": [
        "Project source: backend/pipeline/retrievers/vzp_retriever.py",
        "Project source: components/dashboard/vzp-search-interface.tsx",
        "Project source: components/dashboard/vzp-result-card.tsx"
      ]
    },
    {
      "name": "AI Chat Interface",
      "type": "feature",
      "purpose": "Medical AI assistant chat functionality",
      "verified_package": {
        "name": "Custom implementation",
        "install_command": "N/A - Already implemented",
        "version": "N/A",
        "verified": true
      },
      "api_patterns": {
        "frontend_endpoint": "${NEXT_PUBLIC_API_URL}/api/v1/query",
        "method": "POST",
        "headers": {
          "Content-Type": "application/json",
          "Authorization": "Bearer ${access_token}"
        },
        "request_body": {
          "message": "string",
          "history": [{ "role": "user|assistant", "content": "string" }]
        },
        "response_format": {
          "response": "string",
          "citations": [
            {
              "source": "string (e.g., 'pubmed', 'sukl')",
              "title": "string",
              "url": "string",
              "metadata": "object"
            }
          ]
        },
        "verified_against": "Project source: components/dashboard/chat-interface.tsx"
      },
      "configuration": {
        "env_vars": [
          "NEXT_PUBLIC_API_URL - Backend API URL"
        ],
        "config_files": [],
        "dependencies": [
          "Authenticated user session (Supabase access_token)",
          "Backend API (Python FastAPI)"
        ]
      },
      "frontend_ui": {
        "component": "components/dashboard/chat-interface.tsx",
        "route": "/dashboard/chat",
        "input_placeholder": "Zadejte svůj klinický dotaz...",
        "submit_button": "Odeslat",
        "initial_message": "Ahoj! Jsem Czech MedAI (v2.0)..."
      },
      "e2e_testing_approach": {
        "strategy": "Test chat interaction flow with mocked backend",
        "test_cases": [
          "Send message and verify response appears",
          "Verify loading indicator during request",
          "Check citations display when returned",
          "Error handling when API fails",
          "Authentication required - redirect if not logged in"
        ]
      },
      "gotchas": [
        "Requires authenticated session with valid access_token",
        "Chat history is sent with each request",
        "Backend returns citations that need UI mapping",
        "All UI text is in Czech",
        "ThinkingIndicator component shows during loading"
      ],
      "research_sources": [
        "Project source: components/dashboard/chat-interface.tsx",
        "Project source: app/dashboard/chat/page.tsx"
      ]
    },
    {
      "name": "Next.js",
      "type": "framework",
      "purpose": "React framework for the application",
      "verified_package": {
        "name": "next",
        "install_command": "Already installed",
        "version": "16.0.7",
        "verified": true
      },
      "api_patterns": {
        "router": "App Router (app/ directory)",
        "server_components": true,
        "client_components": "use client directive",
        "server_actions": "use server directive (lib/auth-actions.ts)"
      },
      "configuration": {
        "env_vars": [
          "NEXT_PUBLIC_SUPABASE_URL",
          "NEXT_PUBLIC_SUPABASE_PUBLISHABLE_DEFAULT_KEY",
          "NEXT_PUBLIC_API_URL"
        ],
        "config_files": [
          "next.config.js or next.config.mjs"
        ]
      },
      "e2e_testing_integration": {
        "playwright_webserver": "npm run dev (starts Next.js dev server)",
        "baseURL": "http://localhost:3000",
        "router_hooks_mock": "Can use beforeMount hook for Next.js router mocking in component tests"
      },
      "gotchas": [
        "App Router uses different patterns than Pages Router",
        "Server Actions throw on redirect() - tests need to handle",
        "Need to wait for hydration in E2E tests",
        "React 19 is used - ensure Playwright compatibility"
      ],
      "research_sources": [
        "Project source: package.json",
        "Context7 MCP: /vercel/next.js"
      ]
    }
  ],
  "unverified_claims": [
    {
      "claim": "SUKL API endpoint structure and available endpoints",
      "reason": "SUKL API documentation requires certificate access, couldn't verify specific endpoints beyond what's in codebase",
      "risk_level": "low",
      "mitigation": "E2E tests should mock the backend API layer, not SUKL directly"
    },
    {
      "claim": "VZP verification system official API",
      "reason": "VZP data appears to be stored locally in Supabase, not fetched from external VZP API",
      "risk_level": "low",
      "mitigation": "Current implementation uses Supabase tables for drug pricing/coverage data"
    },
    {
      "claim": "Backend API availability (Python FastAPI)",
      "reason": "Backend runs separately on port 8000, E2E tests need backend running or mocked",
      "risk_level": "medium",
      "mitigation": "Consider mocking backend responses or using a test database"
    }
  ],
  "recommendations": [
    {
      "priority": "high",
      "recommendation": "Use Playwright over Cypress for E2E testing",
      "reason": "Better Next.js integration, official Microsoft support, excellent authentication patterns"
    },
    {
      "priority": "high",
      "recommendation": "Create test user in Supabase for E2E tests",
      "reason": "Authentication flow tests require valid credentials"
    },
    {
      "priority": "high",
      "recommendation": "Store auth state in playwright/.auth/user.json",
      "reason": "Playwright's storageState pattern allows authenticated tests without repeated login"
    },
    {
      "priority": "medium",
      "recommendation": "Mock backend API responses for isolated frontend E2E tests",
      "reason": "Backend (Python) must run separately - mocking simplifies test setup"
    },
    {
      "priority": "medium",
      "recommendation": "Add test:e2e script to package.json",
      "reason": "Standard npm script pattern: 'npx playwright test'"
    },
    {
      "priority": "medium",
      "recommendation": "Use Czech language assertions in tests",
      "reason": "All UI text is in Czech - test assertions should match"
    },
    {
      "priority": "low",
      "recommendation": "Consider running backend in Docker for E2E tests in CI",
      "reason": "Full integration tests require both Next.js and Python backend"
    }
  ],
  "test_user_flows": {
    "flow_1_authentication": {
      "name": "Authentication Flow",
      "steps": [
        "Navigate to /auth/login",
        "Fill email field (label: 'Email')",
        "Fill password field (label: 'Heslo')",
        "Click submit button ('Přihlásit se')",
        "Wait for redirect to /dashboard",
        "Verify authenticated state (check dashboard elements)"
      ],
      "logout_steps": [
        "Trigger signOut action",
        "Verify redirect to /auth/login"
      ]
    },
    "flow_2_ai_chat": {
      "name": "AI Chat with Response Validation",
      "prerequisites": ["Authenticated user session"],
      "steps": [
        "Navigate to /dashboard/chat",
        "Verify initial AI greeting message visible",
        "Type message in input (placeholder: 'Zadejte svůj klinický dotaz...')",
        "Click send button ('Odeslat')",
        "Verify loading indicator appears (ThinkingIndicator)",
        "Wait for AI response to appear",
        "Verify response contains expected structure",
        "If citations present, verify citations display"
      ]
    },
    "flow_3_drug_search_sukl": {
      "name": "Drug Search with SUKL Data",
      "prerequisites": ["Authenticated user session", "Backend API running"],
      "steps": [
        "Navigate to VZP Navigator page",
        "Enter drug name in search (e.g., 'Bisoprolol')",
        "Click search button ('Vyhledat')",
        "Verify loading state ('Hledám...')",
        "Wait for results to appear",
        "Verify result cards contain expected fields (name, ATC, coverage)",
        "Test quick search buttons (Bisoprolol, C07AB, Warfarin)"
      ]
    },
    "flow_4_vzp_verification": {
      "name": "VZP Verification (Drug Coverage)",
      "prerequisites": ["Authenticated user session", "Backend API running"],
      "steps": [
        "Navigate to VZP Navigator page",
        "Search for drug",
        "Verify coverage status displayed (full/partial/limited)",
        "Verify pricing information (max_price, reimbursement, copayment)",
        "Verify conditions and alternatives displayed"
      ]
    }
  },
  "project_structure": {
    "frontend_stack": {
      "framework": "Next.js 16.0.7 (App Router)",
      "react_version": "19.2.0",
      "ui_library": "Radix UI + shadcn/ui components",
      "styling": "Tailwind CSS 4.1.9",
      "forms": "react-hook-form + zod"
    },
    "backend_stack": {
      "language": "Python",
      "framework": "FastAPI (implied from API patterns)",
      "database": "Supabase (PostgreSQL)",
      "location": "backend/ directory"
    },
    "existing_tests": {
      "playwright": false,
      "cypress": false,
      "unit_tests": "backend/tests/test_sukl_retriever.py (Python pytest)"
    }
  },
  "context7_libraries_used": [
    "/microsoft/playwright.dev",
    "/supabase/supabase-js",
    "/supabase/supabase",
    "/vercel/next.js"
  ],
  "created_at": "2024-12-26T10:30:00Z"
}
