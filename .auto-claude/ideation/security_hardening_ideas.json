{
  "security_hardening": [
    {
      "id": "sec-001",
      "type": "security_hardening",
      "title": "Restrict CORS configuration for production",
      "description": "The backend FastAPI application in backend/app/main.py has wide-open CORS configuration with allow_origins=['*'], allow_credentials=True, allow_methods=['*'], and allow_headers=['*']. This allows any website to make cross-origin requests to the API, potentially exposing sensitive medical data to malicious third-party sites.",
      "rationale": "With credentials allowed and origins unrestricted, an attacker could create a malicious website that makes authenticated requests to your API on behalf of logged-in users, stealing their medical query data or performing actions in their name. This is especially critical for a medical application handling sensitive patient information.",
      "category": "configuration",
      "severity": "critical",
      "affectedFiles": ["backend/app/main.py"],
      "vulnerability": "CWE-942: Overly Permissive Cross-domain Whitelist",
      "currentRisk": "Any website can make authenticated API requests, enabling CSRF-like attacks and data exfiltration",
      "remediation": "1. Create an environment variable ALLOWED_ORIGINS containing comma-separated trusted domains\n2. Parse and use this list in CORSMiddleware: allow_origins=settings.ALLOWED_ORIGINS.split(',')\n3. For development, allow localhost origins; for production, only allow your frontend domain (e.g., https://benjamin.cz)\n4. Consider removing allow_credentials=True if not strictly needed, or ensure origins are strictly validated",
      "references": ["https://owasp.org/www-community/attacks/cors-origin-change", "https://cwe.mitre.org/data/definitions/942.html"],
      "compliance": ["GDPR", "SOC2", "HIPAA"]
    },
    {
      "id": "sec-002",
      "type": "security_hardening",
      "title": "Add authentication to admin upload and AI endpoints",
      "description": "The admin endpoint POST /api/v1/admin/upload/guideline allows unauthenticated file uploads. Additionally, the POST /api/v1/query/stream endpoint bypasses authentication entirely despite handling sensitive medical queries. While other query endpoints use Depends(get_current_user), the streaming endpoint does not.",
      "rationale": "Unauthenticated admin endpoints allow anyone to upload potentially malicious PDFs that will be processed and indexed. The unprotected streaming endpoint exposes the AI chat functionality to abuse, allowing unauthorized users to make expensive AI API calls and access medical information without authentication.",
      "category": "authorization",
      "severity": "critical",
      "affectedFiles": ["backend/app/api/v1/endpoints/admin.py", "backend/app/api/v1/endpoints/query.py"],
      "vulnerability": "CWE-306: Missing Authentication for Critical Function",
      "currentRisk": "Anyone can upload files to the server and access the AI chat without authentication",
      "remediation": "1. Add authentication dependency to admin routes: current_user: Dict = Depends(get_current_user)\n2. Implement role-based access control - only admin users should access /admin/* endpoints\n3. Add the same authentication check to the /stream endpoint\n4. Consider adding an admin role check: if current_user.get('role') != 'admin': raise HTTPException(403, 'Admin access required')",
      "references": ["https://owasp.org/Top10/A01_2021-Broken_Access_Control/", "https://cwe.mitre.org/data/definitions/306.html"],
      "compliance": ["SOC2", "HIPAA", "GDPR"]
    },
    {
      "id": "sec-003",
      "type": "security_hardening",
      "title": "Sanitize filenames to prevent path traversal attacks",
      "description": "Both the admin upload endpoint (backend/app/api/v1/endpoints/admin.py) and transcription endpoint (backend/app/api/v1/endpoints/ai.py) use user-provided filenames directly: file_path = os.path.join(UPLOAD_DIR, file.filename) and temp_path = temp_dir / file.filename. An attacker could supply a filename like '../../../etc/passwd' or '..\\..\\windows\\system32\\config' to write files outside the intended directory.",
      "rationale": "Path traversal vulnerabilities can allow attackers to overwrite critical system files, configuration files, or place executable files in unexpected locations. In a medical application, this could lead to complete system compromise and data breach.",
      "category": "input_validation",
      "severity": "high",
      "affectedFiles": ["backend/app/api/v1/endpoints/admin.py", "backend/app/api/v1/endpoints/ai.py"],
      "vulnerability": "CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')",
      "currentRisk": "Attackers can write files to arbitrary locations on the server filesystem",
      "remediation": "1. Use secure_filename from werkzeug.utils or implement custom sanitization:\n   from werkzeug.utils import secure_filename\n   safe_filename = secure_filename(file.filename)\n2. Additionally, generate unique filenames using UUIDs: import uuid; safe_name = f'{uuid.uuid4()}.pdf'\n3. Validate file extension server-side using magic bytes, not just filename extension\n4. Use Path.resolve() and verify the resolved path is still within the upload directory:\n   resolved = (UPLOAD_DIR / safe_filename).resolve()\n   if not str(resolved).startswith(str(UPLOAD_DIR.resolve())): raise HTTPException(400, 'Invalid path')",
      "references": ["https://owasp.org/www-community/attacks/Path_Traversal", "https://cwe.mitre.org/data/definitions/22.html"],
      "compliance": ["SOC2", "PCI-DSS"]
    },
    {
      "id": "sec-004",
      "type": "security_hardening",
      "title": "Add security headers to Next.js and FastAPI responses",
      "description": "The application lacks security headers in both the Next.js frontend (next.config.mjs) and FastAPI backend (main.py). Missing headers include Content-Security-Policy, X-Frame-Options, X-Content-Type-Options, Strict-Transport-Security, and Referrer-Policy. The Next.js config also has typescript.ignoreBuildErrors=true which may hide security-related type errors.",
      "rationale": "Security headers provide defense-in-depth against common web attacks. Without CSP, the app is vulnerable to XSS. Without X-Frame-Options, it can be embedded in malicious iframes for clickjacking. Without HSTS, users may be vulnerable to downgrade attacks on HTTPS connections.",
      "category": "configuration",
      "severity": "medium",
      "affectedFiles": ["next.config.mjs", "backend/app/main.py"],
      "vulnerability": "CWE-1021: Improper Restriction of Rendered UI Layers or Frames",
      "currentRisk": "Application vulnerable to XSS, clickjacking, MIME sniffing, and protocol downgrade attacks",
      "remediation": "1. Add security headers to next.config.mjs:\n   async headers() { return [{ source: '/:path*', headers: [\n     { key: 'X-Frame-Options', value: 'DENY' },\n     { key: 'X-Content-Type-Options', value: 'nosniff' },\n     { key: 'Referrer-Policy', value: 'strict-origin-when-cross-origin' },\n     { key: 'Content-Security-Policy', value: \"default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'\" }\n   ]}]}\n2. Add middleware to FastAPI:\n   from starlette.middleware.base import BaseHTTPMiddleware\n   class SecurityHeadersMiddleware(BaseHTTPMiddleware):\n       async def dispatch(self, request, call_next):\n           response = await call_next(request)\n           response.headers['X-Frame-Options'] = 'DENY'\n           response.headers['X-Content-Type-Options'] = 'nosniff'\n           return response\n3. Remove ignoreBuildErrors: true to catch type-related security issues",
      "references": ["https://owasp.org/www-project-secure-headers/", "https://developer.mozilla.org/en-US/docs/Web/HTTP/CSP"],
      "compliance": ["SOC2", "PCI-DSS"]
    },
    {
      "id": "sec-005",
      "type": "security_hardening",
      "title": "Prevent sensitive data exposure in error messages and improve .env handling",
      "description": "Multiple endpoints expose raw exception details to clients via HTTPException(status_code=500, detail=str(e)), which can leak sensitive information about the system. Additionally, the .gitignore file only excludes '.env*.local' patterns but not the base '.env' file, risking accidental commit of secrets. The backend/.env and .env files contain API keys that could be exposed.",
      "rationale": "Detailed error messages can reveal database schemas, file paths, third-party service names, and internal architecture to attackers. Exposing API keys in version control is a critical security incident that can lead to unauthorized API usage, data breaches, and significant financial costs.",
      "category": "data_protection",
      "severity": "medium",
      "affectedFiles": ["backend/app/api/v1/endpoints/query.py", "backend/app/api/v1/endpoints/admin.py", "backend/app/api/v1/endpoints/ai.py", ".gitignore"],
      "vulnerability": "CWE-209: Generation of Error Message Containing Sensitive Information",
      "currentRisk": "Internal system details exposed to attackers; API keys may be accidentally committed",
      "remediation": "1. Create generic error responses:\n   import logging\n   logger = logging.getLogger(__name__)\n   \n   except Exception as e:\n       logger.error(f'Query failed: {e}', exc_info=True)  # Log full details\n       raise HTTPException(500, detail='An internal error occurred. Please try again later.')  # Generic to user\n\n2. Update .gitignore to exclude all .env files:\n   .env\n   .env.*\n   !.env.example\n   backend/.env\n   backend/.env.*\n   !backend/.env.example\n\n3. Audit git history for any previously committed secrets using: git log -p -- '*.env'\n4. If secrets were committed, rotate all API keys immediately\n5. Consider using a secrets manager (AWS Secrets Manager, HashiCorp Vault) for production",
      "references": ["https://owasp.org/www-community/Improper_Error_Handling", "https://cwe.mitre.org/data/definitions/209.html"],
      "compliance": ["GDPR", "SOC2", "HIPAA"]
    }
  ],
  "metadata": {
    "dependenciesScanned": 67,
    "knownVulnerabilities": 0,
    "filesAnalyzed": 28,
    "criticalIssues": 2,
    "highIssues": 1,
    "mediumIssues": 2,
    "lowIssues": 0,
    "generatedAt": "2025-12-25T13:15:00Z",
    "projectType": "Medical AI Assistant (Next.js + FastAPI)",
    "targetAudience": "Czech medical professionals",
    "specialConsiderations": [
      "Medical data requires HIPAA-like protections",
      "GDPR compliance required for EU users",
      "Sensitive PII including health queries and patient data"
    ]
  }
}
