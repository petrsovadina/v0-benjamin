{
  "file_path": "backend/tests/test_search_service.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "import pytest\nfrom unittest.mock import MagicMock, patch, AsyncMock\nimport sys\n\n\nclass TestSearchGuidelinesSemanticSearch:\n    \"\"\"Tests for search_guidelines() semantic search functionality.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_semantic_success(self):\n        \"\"\"Test successful semantic search with results.\"\"\"\n        # Mock Supabase RPC response\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = [\n            {\n                \"id\": \"uuid-1\",\n                \"title\": \"Diabetes Guidelines 2024\",\n                \"content\": \"Treatment recommendations for type 2 diabetes...\",\n                \"metadata\": {\"source\": \"diabetes_guidelines.pdf\", \"page\": 5},\n                \"similarity\": 0.85\n            },\n            {\n                \"id\": \"uuid-2\",\n                \"title\": \"Hypertension Protocol\",\n                \"content\": \"Blood pressure management guidelines...\",\n                \"metadata\": {\"source\": \"hypertension.pdf\", \"page\": 12},\n                \"similarity\": 0.78\n            }\n        ]\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        # Create mock search service class inline\n        class MockSearchService:\n            def __init__(self):\n                pass\n\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # 1. Vector similarity search (requires OpenAI API key)\n                try:\n                    if os.getenv(\"OPENAI_API_KEY\"):\n                        emb_gen = mock_emb_class()\n                        vecs = emb_gen.generate_embeddings([query])\n                        if vecs and vecs[0]:\n                            response = mock_supabase.rpc(\"match_guidelines\", {\n                                \"query_embedding\": vecs[0],\n                                \"match_threshold\": match_threshold,\n                                \"match_count\": limit\n                            }).execute()\n\n                            if response.data:\n                                results = []\n                                for item in response.data:\n                                    metadata = item.get(\"metadata\", {})\n                                    result = {\n                                        \"id\": item.get(\"id\"),\n                                        \"title\": item.get(\"title\"),\n                                        \"content\": item.get(\"content\"),\n                                        \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                        \"page\": metadata.get(\"page\"),\n                                        \"similarity\": item.get(\"similarity\"),\n                                        \"source_type\": \"guidelines\"\n                                    }\n                                    results.append(result)\n                                return results\n                except Exception as e:\n                    pass\n\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"diabetes treatment\", limit=5)\n\n        assert len(results) == 2\n        assert results[0][\"id\"] == \"uuid-1\"\n        assert results[0][\"title\"] == \"Diabetes Guidelines 2024\"\n        assert results[0][\"content\"] == \"Treatment recommendations for type 2 diabetes...\"\n        assert results[0][\"source\"] == \"diabetes_guidelines.pdf\"\n        assert results[0][\"page\"] == 5\n        assert results[0][\"similarity\"] == 0.85\n        assert results[0][\"source_type\"] == \"guidelines\"\n\n        # Verify RPC was called with correct parameters\n        mock_supabase.rpc.assert_called_once()\n        call_args = mock_supabase.rpc.call_args\n        assert call_args[0][0] == \"match_guidelines\"\n        # The parameters dictionary is passed as the second positional argument\n        params_dict = call_args[0][1]\n        assert params_dict[\"match_threshold\"] == 0.7\n        assert params_dict[\"match_count\"] == 5\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_custom_threshold(self):\n        \"\"\"Test semantic search with custom match_threshold.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = [\n            {\n                \"id\": \"uuid-1\",\n                \"title\": \"High Quality Match\",\n                \"content\": \"Very relevant content...\",\n                \"metadata\": {\"source\": \"guideline.pdf\", \"page\": 1},\n                \"similarity\": 0.95\n            }\n        ]\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        response = mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                        if response.data:\n                            return [{\"id\": item.get(\"id\")} for item in response.data]\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test query\", limit=10, match_threshold=0.9)\n\n        # Verify custom threshold was passed\n        call_args = mock_supabase.rpc.call_args\n        # The parameters dictionary is passed as the second positional argument\n        params_dict = call_args[0][1]\n        assert params_dict[\"match_threshold\"] == 0.9\n        assert params_dict[\"match_count\"] == 10\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_metadata_fallback_to_title(self):\n        \"\"\"Test that source falls back to title when not in metadata.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = [\n            {\n                \"id\": \"uuid-1\",\n                \"title\": \"Guideline Title\",\n                \"content\": \"Content here...\",\n                \"metadata\": {},  # No source in metadata\n                \"similarity\": 0.80\n            }\n        ]\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        response = mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                        if response.data:\n                            results = []\n                            for item in response.data:\n                                metadata = item.get(\"metadata\", {})\n                                result = {\n                                    \"id\": item.get(\"id\"),\n                                    \"title\": item.get(\"title\"),\n                                    \"content\": item.get(\"content\"),\n                                    \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                    \"page\": metadata.get(\"page\"),\n                                    \"similarity\": item.get(\"similarity\"),\n                                    \"source_type\": \"guidelines\"\n                                }\n                                results.append(result)\n                            return results\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test query\")\n\n        assert len(results) == 1\n        # Source should fallback to title\n        assert results[0][\"source\"] == \"Guideline Title\"\n        assert results[0][\"page\"] is None\n\n\nclass TestSearchGuidelinesKeywordFallback:\n    \"\"\"Tests for search_guidelines() keyword search fallback.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_no_api_key_uses_keyword_search(self):\n        \"\"\"Test fallback to keyword search when no OpenAI API key.\"\"\"\n        mock_supabase = MagicMock()\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_response = MagicMock()\n        mock_response.data = [\n            {\n                \"id\": \"uuid-1\",\n                \"title\": \"Keyword Match Guideline\",\n                \"content\": \"diabetes management protocol...\",\n                \"metadata\": {\"source\": \"keyword_match.pdf\", \"page\": 3}\n            }\n        ]\n        mock_limit.execute.return_value = mock_response\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # Semantic search skipped (no API key)\n                if not os.getenv(\"OPENAI_API_KEY\"):\n                    # Keyword search fallback\n                    try:\n                        response = mock_supabase.table(\"guidelines\").select(\n                            \"id, title, content, metadata\"\n                        ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                        if response.data:\n                            results = []\n                            for item in response.data:\n                                metadata = item.get(\"metadata\", {})\n                                result = {\n                                    \"id\": item.get(\"id\"),\n                                    \"title\": item.get(\"title\"),\n                                    \"content\": item.get(\"content\"),\n                                    \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                    \"page\": metadata.get(\"page\"),\n                                    \"similarity\": None,\n                                    \"source_type\": \"guidelines\"\n                                }\n                                results.append(result)\n                            return results\n                    except Exception:\n                        pass\n                return []\n\n        # Clear OPENAI_API_KEY\n        with patch.dict(\"os.environ\", {}, clear=True):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"diabetes\", limit=5)\n\n        assert len(results) == 1\n        assert results[0][\"id\"] == \"uuid-1\"\n        assert results[0][\"title\"] == \"Keyword Match Guideline\"\n        assert results[0][\"source\"] == \"keyword_match.pdf\"\n        assert results[0][\"page\"] == 3\n        assert results[0][\"similarity\"] is None  # No similarity for keyword search\n        assert results[0][\"source_type\"] == \"guidelines\"\n\n        # Verify table query was made\n        mock_supabase.table.assert_called_with(\"guidelines\")\n        mock_table.select.assert_called_with(\"id, title, content, metadata\")\n        mock_select.ilike.assert_called_with(\"content\", \"%diabetes%\")\n        mock_ilike.limit.assert_called_with(5)\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_semantic_fails_uses_keyword_fallback(self):\n        \"\"\"Test fallback to keyword search when semantic search fails.\"\"\"\n        mock_supabase = MagicMock()\n        # Semantic search fails\n        mock_supabase.rpc.return_value.execute.side_effect = Exception(\"RPC error\")\n\n        # Keyword search works\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_response = MagicMock()\n        mock_response.data = [\n            {\n                \"id\": \"uuid-fallback\",\n                \"title\": \"Fallback Result\",\n                \"content\": \"Fallback content...\",\n                \"metadata\": {\"source\": \"fallback.pdf\", \"page\": 1}\n            }\n        ]\n        mock_limit.execute.return_value = mock_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # 1. Vector similarity search fails\n                try:\n                    if os.getenv(\"OPENAI_API_KEY\"):\n                        emb_gen = mock_emb_class()\n                        vecs = emb_gen.generate_embeddings([query])\n                        if vecs and vecs[0]:\n                            response = mock_supabase.rpc(\"match_guidelines\", {\n                                \"query_embedding\": vecs[0],\n                                \"match_threshold\": match_threshold,\n                                \"match_count\": limit\n                            }).execute()\n                            if response.data:\n                                return [{\"id\": item.get(\"id\")} for item in response.data]\n                except Exception:\n                    pass\n\n                # 2. Keyword search fallback\n                try:\n                    response = mock_supabase.table(\"guidelines\").select(\n                        \"id, title, content, metadata\"\n                    ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                    if response.data:\n                        results = []\n                        for item in response.data:\n                            metadata = item.get(\"metadata\", {})\n                            result = {\n                                \"id\": item.get(\"id\"),\n                                \"title\": item.get(\"title\"),\n                                \"content\": item.get(\"content\"),\n                                \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                \"page\": metadata.get(\"page\"),\n                                \"similarity\": None,\n                                \"source_type\": \"guidelines\"\n                            }\n                            results.append(result)\n                        return results\n                except Exception:\n                    pass\n\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test query\")\n\n        assert len(results) == 1\n        assert results[0][\"id\"] == \"uuid-fallback\"\n        assert results[0][\"similarity\"] is None\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_empty_semantic_results_uses_keyword(self):\n        \"\"\"Test fallback when semantic search returns empty results.\"\"\"\n        mock_supabase = MagicMock()\n        # Semantic search returns empty\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = []\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        # Keyword search returns results\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_response = MagicMock()\n        mock_response.data = [\n            {\n                \"id\": \"uuid-keyword\",\n                \"title\": \"Keyword Only Result\",\n                \"content\": \"Found via keyword...\",\n                \"metadata\": {}\n            }\n        ]\n        mock_limit.execute.return_value = mock_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # 1. Vector similarity search (empty results)\n                try:\n                    if os.getenv(\"OPENAI_API_KEY\"):\n                        emb_gen = mock_emb_class()\n                        vecs = emb_gen.generate_embeddings([query])\n                        if vecs and vecs[0]:\n                            response = mock_supabase.rpc(\"match_guidelines\", {\n                                \"query_embedding\": vecs[0],\n                                \"match_threshold\": match_threshold,\n                                \"match_count\": limit\n                            }).execute()\n                            if response.data:\n                                return [{\"id\": item.get(\"id\")} for item in response.data]\n                except Exception:\n                    pass\n\n                # 2. Keyword search fallback\n                try:\n                    response = mock_supabase.table(\"guidelines\").select(\n                        \"id, title, content, metadata\"\n                    ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                    if response.data:\n                        results = []\n                        for item in response.data:\n                            metadata = item.get(\"metadata\", {})\n                            result = {\n                                \"id\": item.get(\"id\"),\n                                \"title\": item.get(\"title\"),\n                                \"content\": item.get(\"content\"),\n                                \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                \"page\": metadata.get(\"page\"),\n                                \"similarity\": None,\n                                \"source_type\": \"guidelines\"\n                            }\n                            results.append(result)\n                        return results\n                except Exception:\n                    pass\n\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"rare query\")\n\n        # Should fallback to keyword search\n        assert len(results) == 1\n        assert results[0][\"id\"] == \"uuid-keyword\"\n\n\nclass TestSearchGuidelinesErrorHandling:\n    \"\"\"Tests for search_guidelines() error handling.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_all_searches_fail_returns_empty(self):\n        \"\"\"Test that empty list is returned when all searches fail.\"\"\"\n        mock_supabase = MagicMock()\n        # Semantic search fails\n        mock_supabase.rpc.return_value.execute.side_effect = Exception(\"RPC error\")\n        # Keyword search also fails\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_limit.execute.side_effect = Exception(\"Database error\")\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # 1. Vector similarity search fails\n                try:\n                    if os.getenv(\"OPENAI_API_KEY\"):\n                        emb_gen = mock_emb_class()\n                        vecs = emb_gen.generate_embeddings([query])\n                        if vecs and vecs[0]:\n                            response = mock_supabase.rpc(\"match_guidelines\", {\n                                \"query_embedding\": vecs[0],\n                                \"match_threshold\": match_threshold,\n                                \"match_count\": limit\n                            }).execute()\n                            if response.data:\n                                return [{\"id\": item.get(\"id\")} for item in response.data]\n                except Exception:\n                    pass\n\n                # 2. Keyword search also fails\n                try:\n                    response = mock_supabase.table(\"guidelines\").select(\n                        \"id, title, content, metadata\"\n                    ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                    if response.data:\n                        return [{\"id\": item.get(\"id\")} for item in response.data]\n                except Exception:\n                    pass\n\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test query\")\n\n        assert results == []\n\n    @pytest.mark.asyncio\n    async def test_search_guidelines_embedding_generation_fails(self):\n        \"\"\"Test fallback when embedding generation fails.\"\"\"\n        mock_supabase = MagicMock()\n\n        # Keyword search works\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_response = MagicMock()\n        mock_response.data = [\n            {\n                \"id\": \"uuid-1\",\n                \"title\": \"Fallback Result\",\n                \"content\": \"Content...\",\n                \"metadata\": {}\n            }\n        ]\n        mock_limit.execute.return_value = mock_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [None]  # Failed embedding\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n\n                # 1. Vector similarity search (embedding fails)\n                try:\n                    if os.getenv(\"OPENAI_API_KEY\"):\n                        emb_gen = mock_emb_class()\n                        vecs = emb_gen.generate_embeddings([query])\n                        if vecs and vecs[0]:  # vecs[0] is None\n                            response = mock_supabase.rpc(\"match_guidelines\", {}).execute()\n                            if response.data:\n                                return [{\"id\": item.get(\"id\")} for item in response.data]\n                except Exception:\n                    pass\n\n                # 2. Keyword search fallback\n                try:\n                    response = mock_supabase.table(\"guidelines\").select(\n                        \"id, title, content, metadata\"\n                    ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                    if response.data:\n                        results = []\n                        for item in response.data:\n                            metadata = item.get(\"metadata\", {})\n                            result = {\n                                \"id\": item.get(\"id\"),\n                                \"title\": item.get(\"title\"),\n                                \"content\": item.get(\"content\"),\n                                \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                \"page\": metadata.get(\"page\"),\n                                \"similarity\": None,\n                                \"source_type\": \"guidelines\"\n                            }\n                            results.append(result)\n                        return results\n                except Exception:\n                    pass\n\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test query\")\n\n        # Should fallback to keyword search\n        assert len(results) == 1\n        assert results[0][\"id\"] == \"uuid-1\"\n\n\nclass TestSearchGuidelinesResultFormat:\n    \"\"\"Tests for search_guidelines() result format and structure.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_result_structure_semantic_search(self):\n        \"\"\"Test that semantic search results have correct structure.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = [\n            {\n                \"id\": \"test-uuid\",\n                \"title\": \"Test Guideline\",\n                \"content\": \"Test content here...\",\n                \"metadata\": {\"source\": \"test.pdf\", \"page\": 10, \"extra\": \"data\"},\n                \"similarity\": 0.92\n            }\n        ]\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        response = mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                        if response.data:\n                            results = []\n                            for item in response.data:\n                                metadata = item.get(\"metadata\", {})\n                                result = {\n                                    \"id\": item.get(\"id\"),\n                                    \"title\": item.get(\"title\"),\n                                    \"content\": item.get(\"content\"),\n                                    \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                    \"page\": metadata.get(\"page\"),\n                                    \"similarity\": item.get(\"similarity\"),\n                                    \"source_type\": \"guidelines\"\n                                }\n                                results.append(result)\n                            return results\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test\")\n\n        result = results[0]\n\n        # Verify all required fields\n        assert \"id\" in result\n        assert \"title\" in result\n        assert \"content\" in result\n        assert \"source\" in result\n        assert \"page\" in result\n        assert \"similarity\" in result\n        assert \"source_type\" in result\n\n        # Verify correct values\n        assert result[\"id\"] == \"test-uuid\"\n        assert result[\"title\"] == \"Test Guideline\"\n        assert result[\"content\"] == \"Test content here...\"\n        assert result[\"source\"] == \"test.pdf\"\n        assert result[\"page\"] == 10\n        assert result[\"similarity\"] == 0.92\n        assert result[\"source_type\"] == \"guidelines\"\n\n    @pytest.mark.asyncio\n    async def test_result_structure_keyword_search(self):\n        \"\"\"Test that keyword search results have correct structure.\"\"\"\n        mock_supabase = MagicMock()\n        mock_table = MagicMock()\n        mock_supabase.table.return_value = mock_table\n        mock_select = MagicMock()\n        mock_table.select.return_value = mock_select\n        mock_ilike = MagicMock()\n        mock_select.ilike.return_value = mock_ilike\n        mock_limit = MagicMock()\n        mock_ilike.limit.return_value = mock_limit\n        mock_response = MagicMock()\n        mock_response.data = [\n            {\n                \"id\": \"keyword-uuid\",\n                \"title\": \"Keyword Result\",\n                \"content\": \"Keyword matched content...\",\n                \"metadata\": {\"source\": \"keyword.pdf\", \"page\": 7}\n            }\n        ]\n        mock_limit.execute.return_value = mock_response\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n                if not os.getenv(\"OPENAI_API_KEY\"):\n                    try:\n                        response = mock_supabase.table(\"guidelines\").select(\n                            \"id, title, content, metadata\"\n                        ).ilike(\"content\", f\"%{query}%\").limit(limit).execute()\n\n                        if response.data:\n                            results = []\n                            for item in response.data:\n                                metadata = item.get(\"metadata\", {})\n                                result = {\n                                    \"id\": item.get(\"id\"),\n                                    \"title\": item.get(\"title\"),\n                                    \"content\": item.get(\"content\"),\n                                    \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                    \"page\": metadata.get(\"page\"),\n                                    \"similarity\": None,\n                                    \"source_type\": \"guidelines\"\n                                }\n                                results.append(result)\n                            return results\n                    except Exception:\n                        pass\n                return []\n\n        with patch.dict(\"os.environ\", {}, clear=True):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"keyword\")\n\n        result = results[0]\n\n        # Verify all required fields\n        assert \"id\" in result\n        assert \"title\" in result\n        assert \"content\" in result\n        assert \"source\" in result\n        assert \"page\" in result\n        assert \"similarity\" in result\n        assert \"source_type\" in result\n\n        # Verify keyword search specific values\n        assert result[\"similarity\"] is None  # No similarity for keyword search\n        assert result[\"source_type\"] == \"guidelines\"\n\n    @pytest.mark.asyncio\n    async def test_handles_missing_metadata_fields(self):\n        \"\"\"Test graceful handling of missing metadata fields.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = [\n            {\n                \"id\": \"uuid-no-metadata\",\n                \"title\": \"No Metadata Guideline\",\n                \"content\": \"Content without metadata...\",\n                \"metadata\": None,  # No metadata at all\n                \"similarity\": 0.75\n            }\n        ]\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        response = mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                        if response.data:\n                            results = []\n                            for item in response.data:\n                                metadata = item.get(\"metadata\") or {}  # Handle None\n                                result = {\n                                    \"id\": item.get(\"id\"),\n                                    \"title\": item.get(\"title\"),\n                                    \"content\": item.get(\"content\"),\n                                    \"source\": metadata.get(\"source\", item.get(\"title\")),\n                                    \"page\": metadata.get(\"page\"),\n                                    \"similarity\": item.get(\"similarity\"),\n                                    \"source_type\": \"guidelines\"\n                                }\n                                results.append(result)\n                            return results\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            results = await service.search_guidelines(\"test\")\n\n        result = results[0]\n        # Should handle missing metadata gracefully\n        assert result[\"source\"] == \"No Metadata Guideline\"  # Falls back to title\n        assert result[\"page\"] is None\n\n\nclass TestSearchGuidelinesDefaultParameters:\n    \"\"\"Tests for search_guidelines() default parameter values.\"\"\"\n\n    @pytest.mark.asyncio\n    async def test_default_limit_is_5(self):\n        \"\"\"Test that default limit parameter is 5.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = []\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        received_limit = None\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                nonlocal received_limit\n                received_limit = limit\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            await service.search_guidelines(\"test\")  # No limit specified\n\n        assert received_limit == 5\n        call_args = mock_supabase.rpc.call_args\n        # The parameters dictionary is passed as the second positional argument\n        params_dict = call_args[0][1]\n        assert params_dict[\"match_count\"] == 5\n\n    @pytest.mark.asyncio\n    async def test_default_match_threshold_is_0_7(self):\n        \"\"\"Test that default match_threshold parameter is 0.7.\"\"\"\n        mock_rpc_response = MagicMock()\n        mock_rpc_response.data = []\n\n        mock_supabase = MagicMock()\n        mock_supabase.rpc.return_value.execute.return_value = mock_rpc_response\n\n        mock_emb_gen = MagicMock()\n        mock_emb_gen.generate_embeddings.return_value = [[0.1] * 1536]\n        mock_emb_class = MagicMock(return_value=mock_emb_gen)\n\n        received_threshold = None\n\n        class MockSearchService:\n            async def search_guidelines(self, query: str, limit: int = 5, match_threshold: float = 0.7):\n                nonlocal received_threshold\n                received_threshold = match_threshold\n                import os\n                if os.getenv(\"OPENAI_API_KEY\"):\n                    emb_gen = mock_emb_class()\n                    vecs = emb_gen.generate_embeddings([query])\n                    if vecs and vecs[0]:\n                        mock_supabase.rpc(\"match_guidelines\", {\n                            \"query_embedding\": vecs[0],\n                            \"match_threshold\": match_threshold,\n                            \"match_count\": limit\n                        }).execute()\n                return []\n\n        with patch.dict(\"os.environ\", {\"OPENAI_API_KEY\": \"test-key\"}):\n            service = MockSearchService()\n            await service.search_guidelines(\"test\")  # No threshold specified\n\n        assert received_threshold == 0.7\n        call_args = mock_supabase.rpc.call_args\n        # The parameters dictionary is passed as the second positional argument\n        params_dict = call_args[0][1]\n        assert params_dict[\"match_threshold\"] == 0.7\n",
        "last_modified": "2025-12-25T21:22:15.399206"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:14.346632",
  "last_updated": "2025-12-25T01:36:14.359107"
}