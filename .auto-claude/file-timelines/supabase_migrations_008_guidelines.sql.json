{
  "file_path": "supabase/migrations/008_guidelines.sql",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "-- Migration 008: Guidelines Table for RAG Pipeline\n-- Stores Czech medical guideline chunks with embeddings for vector similarity search\n\n-- Enable pgvector extension if not already enabled\nCREATE EXTENSION IF NOT EXISTS vector;\n\n-- Create guidelines table for storing chunked guideline content\nCREATE TABLE IF NOT EXISTS guidelines (\n    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),\n    title TEXT NOT NULL,\n    organization TEXT DEFAULT 'Unknown',\n    publication_year TEXT,\n    content TEXT NOT NULL,\n    embedding vector(1536),\n    metadata JSONB DEFAULT '{}',\n    is_czech BOOLEAN DEFAULT TRUE,\n    full_content TEXT,\n    created_at TIMESTAMPTZ DEFAULT NOW(),\n    updated_at TIMESTAMPTZ DEFAULT NOW()\n);\n\n-- Create HNSW index for fast cosine similarity search on embeddings\nCREATE INDEX IF NOT EXISTS idx_guidelines_embedding\nON guidelines\nUSING hnsw (embedding vector_cosine_ops);\n\n-- Create index on metadata for efficient filtering by source\nCREATE INDEX IF NOT EXISTS idx_guidelines_metadata\nON guidelines\nUSING gin (metadata);\n\n-- Create index on title for duplicate detection\nCREATE INDEX IF NOT EXISTS idx_guidelines_title\nON guidelines (title);\n\n-- RPC function for vector similarity search on guidelines\nCREATE OR REPLACE FUNCTION match_guidelines(\n    query_embedding vector(1536),\n    match_threshold float,\n    match_count int\n)\nRETURNS TABLE (\n    id uuid,\n    title text,\n    content text,\n    metadata jsonb,\n    similarity float\n)\nLANGUAGE plpgsql\nAS $$\nBEGIN\n    RETURN QUERY\n    SELECT\n        guidelines.id,\n        guidelines.title,\n        guidelines.content,\n        guidelines.metadata,\n        1 - (guidelines.embedding <=> query_embedding) AS similarity\n    FROM guidelines\n    WHERE 1 - (guidelines.embedding <=> query_embedding) > match_threshold\n    ORDER BY guidelines.embedding <=> query_embedding\n    LIMIT match_count;\nEND;\n$$;\n\n-- Trigger to update updated_at timestamp\nCREATE OR REPLACE FUNCTION update_guidelines_updated_at()\nRETURNS TRIGGER AS $$\nBEGIN\n    NEW.updated_at = NOW();\n    RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER guidelines_updated_at_trigger\n    BEFORE UPDATE ON guidelines\n    FOR EACH ROW\n    EXECUTE FUNCTION update_guidelines_updated_at();\n\n-- Grant permissions (adjust based on your RLS policies)\nALTER TABLE guidelines ENABLE ROW LEVEL SECURITY;\n\n-- Policy for authenticated users to read guidelines\nCREATE POLICY \"Allow authenticated users to read guidelines\"\n    ON guidelines\n    FOR SELECT\n    TO authenticated\n    USING (true);\n\n-- Policy for service role to manage guidelines (for background processing)\nCREATE POLICY \"Allow service role full access\"\n    ON guidelines\n    FOR ALL\n    TO service_role\n    USING (true)\n    WITH CHECK (true);\n\nCOMMENT ON TABLE guidelines IS 'Stores chunked Czech medical guidelines with embeddings for RAG retrieval';\nCOMMENT ON COLUMN guidelines.content IS 'Chunk text content for vector search';\nCOMMENT ON COLUMN guidelines.embedding IS '1536-dimensional OpenAI text-embedding-3-small vector';\nCOMMENT ON COLUMN guidelines.metadata IS 'JSONB containing source filename, page number, and other metadata for citations';\n",
        "last_modified": "2025-12-25T21:22:15.409714"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:14.448379",
  "last_updated": "2025-12-25T01:36:14.462051"
}