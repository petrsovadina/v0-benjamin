{
  "file_path": "backend/data_processing/loaders/price_history_loader.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "from typing import List, Dict, Any\nimport logging\nfrom backend.data_processing.utils.supabase_client import SupabaseSingleton\n\nlogger = logging.getLogger(__name__)\n\nclass PriceHistoryLoader:\n    \"\"\"\n    Loads price history data into Supabase 'price_history' table.\n    \"\"\"\n    def __init__(self):\n        self.supabase = SupabaseSingleton.get_client()\n\n    def load_price_history(self, history_items: List[Dict[str, Any]], batch_size: int = 100):\n        total = len(history_items)\n        logger.info(f\"Starting upload of {total} historical price records to Supabase...\")\n        \n        # We need to filter out items without date or sukl_code\n        valid_items = [i for i in history_items if i.get('sukl_code') and i.get('valid_from')]\n        if len(valid_items) < total:\n            logger.warning(f\"Filtered out {total - len(valid_items)} invalid price records (missing code or date)\")\n            total = len(valid_items)\n\n        for i in range(0, total, batch_size):\n            batch = valid_items[i : i + batch_size]\n            try:\n                # Insert history. We likely won't update, just append.\n                # If we need upsert, we need a unique constraint on (sukl_code, valid_from).\n                # For now, simple insert is safer than upsert without constraint, but might duplicate on rerun.\n                # Let's assume we want to avoid dups.\n                \n                # We can't easily upsert without a unique constraint.\n                # Assuming the user might re-run, checking existence or using upsert on (sukl_code, valid_from) would be best.\n                # But we defined the table with only PK on ID.\n                # Strategy: Just Insert. (User can clear table if needed)\n                \n                # Better: Upsert if we add constraint. But constrained migration wasn't added yet.\n                # Falling back to regular Insert.\n                \n                data = self.supabase.table(\"price_history\").insert(batch).execute()\n                logger.info(f\"Uploaded batch {i//batch_size + 1}/{(total//batch_size) + 1}\")\n            except Exception as e:\n                logger.error(f\"Error uploading batch starting at index {i}: {e}\")\n                \n        logger.info(\"Price history upload complete.\")\n",
        "last_modified": "2025-12-25T21:22:14.908646"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:13.282049",
  "last_updated": "2025-12-25T01:36:13.296914"
}