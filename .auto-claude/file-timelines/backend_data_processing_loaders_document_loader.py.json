{
  "file_path": "backend/data_processing/loaders/document_loader.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "from typing import List, Dict, Any\nimport logging\nfrom backend.data_processing.utils.supabase_client import SupabaseSingleton\n\nlogger = logging.getLogger(__name__)\n\nclass DocumentLoader:\n    \"\"\"\n    Loads SPC/PIL documents into Supabase tables.\n    \"\"\"\n    def __init__(self):\n        self.supabase = SupabaseSingleton.get_client()\n\n    def load_documents(self, spc_docs: List[Dict[str, Any]], pil_docs: List[Dict[str, Any]], batch_size: int = 100):\n        \n        def _upload(table: str, items: List[Dict]):\n            total = len(items)\n            if total == 0: return\n            logger.info(f\"Uploading {total} to {table}...\")\n            for i in range(0, total, batch_size):\n                batch = items[i : i + batch_size]\n                try:\n                    # Workaround for missing unique constraint on sukl_code\n                    # 1. Delete existing for this batch\n                    codes = [item[\"sukl_code\"] for item in batch]\n                    self.supabase.table(table).delete().in_(\"sukl_code\", codes).execute()\n                    \n                    # 2. Insert new\n                    self.supabase.table(table).insert(batch).execute()\n                    logger.info(f\"Uploaded {table} batch {i//batch_size + 1}\")\n                except Exception as e:\n                    logger.error(f\"Error uploading to {table}: {e}\")\n\n        if spc_docs:\n            _upload(\"spc_documents\", spc_docs)\n            \n        if pil_docs:\n            _upload(\"pil_documents\", pil_docs)\n\n            \n        logger.info(\"Documents upload complete.\")\n\n    # Helper to fetch drugs for processing\n    def fetch_all_drugs_codes(self) -> List[Dict[str, Any]]:\n        # Limit to 100 for MVP testing to avoid massive fetch\n        resp = self.supabase.table(\"drugs\").select(\"sukl_code, name\").limit(100).execute()\n        return resp.data\n",
        "last_modified": "2025-12-25T21:22:14.902925"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:13.223506",
  "last_updated": "2025-12-25T01:36:13.236323"
}