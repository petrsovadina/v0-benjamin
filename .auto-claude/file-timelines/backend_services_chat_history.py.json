{
  "file_path": "backend/services/chat_history.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "from typing import List, Dict, Optional, Any\nimport uuid\nimport logging\nfrom backend.data_processing.utils.supabase_client import SupabaseSingleton\n\nlogger = logging.getLogger(__name__)\n\nclass ChatHistoryService:\n    def __init__(self):\n        self.supabase = SupabaseSingleton.get_client()\n\n    async def create_session(self, user_id: Optional[str] = None, title: str = \"Nov\u00e1 konverzace\") -> str:\n        \"\"\"Creates a new chat session and returns its ID.\"\"\"\n        try:\n            data = {\n                \"title\": title\n            }\n            if user_id:\n                data[\"user_id\"] = user_id\n                \n            response = self.supabase.table(\"chat_sessions\").insert(data).execute()\n            if response.data:\n                return response.data[0][\"id\"]\n            raise Exception(\"Failed to create session\")\n        except Exception as e:\n            logger.error(f\"Error creating chat session: {e}\")\n            # Fallback to a generated UUID if DB fails, though this won't persist\n            return str(uuid.uuid4())\n\n    async def add_message(self, session_id: str, role: str, content: str, citations: Optional[List[Dict]] = None):\n        \"\"\"Adds a message to a session.\"\"\"\n        try:\n            data = {\n                \"session_id\": session_id,\n                \"role\": role,\n                \"content\": content\n            }\n            if citations:\n                data[\"citations\"] = citations\n                \n            self.supabase.table(\"chat_messages\").insert(data).execute()\n        except Exception as e:\n            logger.error(f\"Error adding message to session {session_id}: {e}\")\n\n    async def get_user_sessions(self, user_id: str) -> List[Dict[str, Any]]:\n        \"\"\"Retrieves all sessions for a user.\"\"\"\n        try:\n            response = self.supabase.table(\"chat_sessions\") \\\n                .select(\"*\") \\\n                .eq(\"user_id\", user_id) \\\n                .order(\"updated_at\", desc=True) \\\n                .execute()\n            return response.data\n        except Exception as e:\n            logger.error(f\"Error fetching user sessions: {e}\")\n            return []\n\n    async def get_session_messages(self, session_id: str) -> List[Dict[str, Any]]:\n        \"\"\"Retrieves messages for a specific session.\"\"\"\n        try:\n            response = self.supabase.table(\"chat_messages\") \\\n                .select(\"*\") \\\n                .eq(\"session_id\", session_id) \\\n                .order(\"created_at\", desc=False) \\\n                .execute()\n            return response.data\n        except Exception as e:\n            logger.error(f\"Error fetching session messages: {e}\")\n            return []\n",
        "last_modified": "2025-12-25T21:22:15.368414"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:14.095581",
  "last_updated": "2025-12-25T01:36:14.108523"
}