{
  "file_path": "backend/pipeline/retrievers/sukl_retriever.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "from typing import List, Dict, Any\nfrom backend.services.logger import get_logger\nfrom backend.data_processing.utils.supabase_client import SupabaseSingleton\nfrom backend.services.cache import cache\n\nlogger = get_logger(__name__)\n\nclass SuklRetriever:\n    \"\"\"\n    Retrieves drug information from the local S\u00daKL database (Supabase).\n    \"\"\"\n    def __init__(self):\n        self.supabase = SupabaseSingleton.get_client()\n\n    async def search_drugs(self, query: str) -> str:\n        \"\"\"\n        Searches for drugs by name (using connection to Supabase).\n        Returns a formatted string suitable for LLM context.\n        \"\"\"\n        # Check cache\n        cache_key = f\"sukl:{query}\"\n        cached_result = cache.get(cache_key)\n        if cached_result:\n            logger.info(\"S\u00daKL search cache hit\", query=query)\n            return cached_result\n\n        logger.info(f\"Searching S\u00daKL for: {query}\")\n        # Simple ILIKE search for now. \n        # In production, use Full Text Search (to_tsvector) or Semantic Search (vectors).\n        try:\n            response = self.supabase.table(\"drugs\") \\\n                .select(\"*\") \\\n                .ilike(\"name_normalized\", f\"%{query.lower()}%\") \\\n                .limit(5) \\\n                .execute()\n            \n            drugs = response.data\n            if not drugs:\n                logger.info(\"No S\u00daKL results found\", query=query)\n                return f\"No drugs found matching '{query}'.\"\n            \n            # Format results\n            result_text = f\"Found {len(drugs)} drugs matching '{query}':\\n\"\n            for drug in drugs:\n                # Construct official S\u00daKL info URL\n                sukl_url = f\"https://www.sukl.cz/modules/medication/detail.php?code={drug['sukl_code']}&tab=info\"\n                \n                result_text += f\"- {drug['name']} (S\u00daKL: {drug['sukl_code']})\\n\"\n                result_text += f\"  Reference Link: {sukl_url}\\n\"\n                result_text += f\"  Active Substance: {drug.get('active_substance', 'N/A')}\\n\"\n                result_text += f\"  Strength: {drug.get('strength', 'N/A')}, Form: {drug.get('pharmaceutical_form', 'N/A')}\\n\"\n                # Add pricing if/when available in joined table\n                result_text += \"\\n\"\n            \n            # Save to cache (TTL 30 mins)\n            cache.set(cache_key, result_text, ttl=1800)\n            \n            logger.info(\"S\u00daKL search returned results\", count=len(drugs))\n            return result_text\n            \n        except Exception as e:\n            logger.error(\"Error querying drug database\", error=e)\n            return f\"Error querying drug database: {str(e)}\"\n",
        "last_modified": "2025-12-25T21:22:15.350736"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:13.921449",
  "last_updated": "2025-12-25T01:36:13.934898"
}