{
  "file_path": "backend/tests/test_api_integration.py",
  "main_branch_history": [],
  "task_views": {
    "001-complete-guidelines-rag-pdf-import": {
      "task_id": "001-complete-guidelines-rag-pdf-import",
      "branch_point": {
        "commit_hash": "d092d181e511c0ef7a36dcfd2dfe3f083cbae73e",
        "content": "",
        "timestamp": "2025-12-25T01:35:52.079046"
      },
      "worktree_state": {
        "content": "import pytest\nimport httpx\nfrom fastapi.testclient import TestClient\nfrom backend.main import app\nfrom backend.app.api.v1.deps import get_current_user\nimport sys\nfrom unittest.mock import MagicMock, patch, AsyncMock\n\n# Pou\u017eijeme TestClient pro rychl\u00e9 integra\u010dn\u00ed testy v pam\u011bti\nclient = TestClient(app)\n\ndef test_health_check():\n    \"\"\"Ov\u011b\u0159\u00ed, \u017ee health check endpoint vrac\u00ed 200 OK.\"\"\"\n    response = client.get(\"/health\")\n    assert response.status_code == 200\n    assert response.json() == {\"status\": \"healthy\"}\n\ndef test_query_endpoint_structure(mock_graph_app, mock_supabase):\n    \"\"\"Ov\u011b\u0159\u00ed strukturu s mockovan\u00fdm u\u017eivatelem.\"\"\"\n    app.dependency_overrides[get_current_user] = lambda: {\"id\": \"test_user\"}\n    \n    with patch(\"backend.app.api.v1.endpoints.query.graph_app\", mock_graph_app), \\\n         patch(\"backend.app.api.v1.endpoints.query.get_supabase_client\", return_value=mock_supabase):\n        # Test validace vstupu (invalidn\u00ed typ pro message)\n        response = client.post(\"/api/v1/query\", json={\"message\": 123})\n        \n    app.dependency_overrides = {}\n    \n    # 422 Unprocessable Entity expected due to type mismatch\n    assert response.status_code == 422\n\n@pytest.fixture\ndef mock_graph_app():\n    mock_app = MagicMock()\n    return mock_app\n\n@pytest.fixture\ndef mock_supabase():\n    mock_client = MagicMock()\n    mock_table = MagicMock()\n    mock_client.table.return_value = mock_table\n    mock_table.insert.return_value.execute.return_value.data = [{\"id\": \"test_id\"}]\n    mock_table.update.return_value.eq.return_value.execute.return_value = None\n    return mock_client\n\ndef test_query_endpoint_success(mock_graph_app, mock_supabase):\n    \"\"\"Simuluje \u00fasp\u011b\u0161nou odpov\u011b\u010f agenta.\"\"\"\n    \n    mock_graph_app.ainvoke = AsyncMock(return_value={\n        \"final_answer\": \"Ahoj, jsem Benjamin.\",\n        \"query_type\": \"quick\",\n        \"retrieved_context\": []\n    })\n\n    with patch(\"backend.app.api.v1.endpoints.query.graph_app\", mock_graph_app), \\\n         patch(\"backend.app.api.v1.endpoints.query.get_supabase_client\", return_value=mock_supabase):\n         \n         app.dependency_overrides[get_current_user] = lambda: {\"id\": \"test_user\"}\n         \n         payload = {\"message\": \"Ahoj\"}\n         response = client.post(\"/api/v1/query\", json=payload)\n         \n         app.dependency_overrides = {}\n    \n    assert response.status_code == 200\n    data = response.json()\n    assert data[\"response\"] == \"Ahoj, jsem Benjamin.\"\n\ndef test_rate_limit_headers(mock_graph_app, mock_supabase):\n    \"\"\"Ov\u011b\u0159\u00ed, \u017ee odpov\u011b\u010f je OK (rate limit headers check skipped).\"\"\"\n    mock_graph_app.ainvoke = AsyncMock(return_value={\n        \"final_answer\": \"OK\",\n        \"query_type\": \"quick\" \n    })\n\n    with patch(\"backend.app.api.v1.endpoints.query.graph_app\", mock_graph_app), \\\n         patch(\"backend.app.api.v1.endpoints.query.get_supabase_client\", return_value=mock_supabase):\n        \n        app.dependency_overrides[get_current_user] = lambda: {\"id\": \"test_user\"}\n        \n        response = client.post(\"/api/v1/query\", json={\"message\": \"check headers\"})\n        \n        app.dependency_overrides = {}\n    \n    assert response.status_code == 200\n",
        "last_modified": "2025-12-25T21:22:15.391604"
      },
      "task_intent": {
        "title": "001-complete-guidelines-rag-pdf-import",
        "description": "",
        "from_plan": false
      },
      "commits_behind_main": 0,
      "status": "active",
      "merged_at": null
    }
  },
  "created_at": "2025-12-25T01:36:14.289132",
  "last_updated": "2025-12-25T01:36:14.302483"
}