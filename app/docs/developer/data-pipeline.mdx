# ğŸ“Š Data Pipeline Documentation

Tento dokument popisuje datovou architekturu projektu Benjamin a procesy zÃ­skÃ¡vÃ¡nÃ­ a zpracovÃ¡nÃ­ lÃ©kaÅ™skÃ½ch dat.

## ğŸ—ï¸ Architektura

Data pipeline je postavena nad Python backendem a vyuÅ¾Ã­vÃ¡ asynchronnÃ­ zpracovÃ¡nÃ­ pro stahovÃ¡nÃ­ a parsovÃ¡nÃ­ dat.

### Zdroje Dat
1. **SÃšKL Open Data**: OficiÃ¡lnÃ­ data o lÃ©Äivech v ÄŒR.
   - DatovÃ¡ sada DLP (DatabÃ¡ze lÃ©ÄivÃ½ch pÅ™Ã­pravkÅ¯).
   - SPC a PIL dokumenty (PDF).
   - CenÃ­ky a Ãºhrady (CSV/Excel).
   - *Aktualizace:* SpouÅ¡tÃ­ se manuÃ¡lnÄ›/cronem (skript `import_sukl_data.py`).
2. **PubMed**: BiomedicÃ­nskÃ¡ literatura.
   - PÅ™Ã­stup pÅ™es NCBI E-utilities API.
   - Real-time vyhledÃ¡vÃ¡nÃ­ (neskladujeme vÅ¡e, jen cachujeme vÃ½sledky).

---

## ğŸ› ï¸ Komponenty Pipeline

### 1. Parsery (`backend/data_processing/parsers`)
- `SuklDlpParser`: ParÅ¡uje CSV/JSON exporty ze SÃšKL. Normalizuje nÃ¡zvy lÃ©kÅ¯ a extrahuje kÃ³dy.
- `SpcPilParser`: 
  - Generuje odkazy na oficiÃ¡lnÃ­ PDF dokumenty.
  - V budoucnu: Stahuje PDF, extrahuje text pomocÃ­ `pdfplumber` a chunkuje pro embeddingy.
- `SukPricingParser`: ZpracovÃ¡vÃ¡ cenÃ­ky a pÃ¡ruje ceny (OER, MFC) k lÃ©kÅ¯m podle SÃšKL kÃ³dÅ¯.

### 2. Retrievery (`backend/pipeline/retrievers`)
Tyto tÅ™Ã­dy pouÅ¾Ã­vÃ¡ AI Agent pro zÃ­skÃ¡vÃ¡nÃ­ kontextu.
- `SuklRetriever`: 
  - VyhledÃ¡vÃ¡ lÃ©ky v Supabase databÃ¡zi (tabulka `drugs`).
  - Podporuje `ILike` vyhledÃ¡vÃ¡nÃ­ a vracÃ­ strukturovanÃ¡ metadata + odkazy.
  - PouÅ¾Ã­vÃ¡ `SimpleCache` (TTL 30 min).
- `PubMedRetriever`:
  - VolÃ¡ externÃ­ API pro vÄ›deckÃ© ÄlÃ¡nky.
  - FormÃ¡tuje abstrakty pro LLM.
  - PouÅ¾Ã­vÃ¡ `SimpleCache` (TTL 1 hod).

---

## ğŸ—„ï¸ DatabÃ¡ze (Supabase)

Data jsou uklÃ¡dÃ¡na do PostgreSQL v Supabase.

### SchÃ©ma (ZjednoduÅ¡enÃ©)
- `drugs`: HlavnÃ­ tabulka lÃ©kÅ¯ (SÃšKL kÃ³d, nÃ¡zev, sÃ­la, forma).
- `documents` (Planned): TextovÃ© chunky z SPC/PIL + vektory (`pgvector`).
- `app_errors`: LogovÃ¡nÃ­ chyb pipeline a aplikace.

---

## ğŸš€ Jak spustit import dat

Pro manuÃ¡lnÃ­ spuÅ¡tÄ›nÃ­ importu (po deploymentu nebo lokÃ¡lnÄ›):

```bash
# From project root
python -m backend.pipeline.run_pipeline --all
```

*PoznÃ¡mka: UjistÄ›te se, Å¾e mÃ¡te nastavenÃ© `SUPABASE_URL` a `SUPABASE_SERVICE_KEY`.*
